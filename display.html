<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Club Picture Day Queue Display</title>
  <style>
  :root{
    --bg: #f5f7fb;
    --card: #ffffff;
    --card2: #ffffff;
    --border: rgba(15, 23, 42, .12);
    --text: rgba(15, 23, 42, .92);
    --muted: rgba(15, 23, 42, .62);
    --accent: #2563eb;   /* blue */
    --ok: #16a34a;       /* green */
    --warn: #f59e0b;

    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  /* Full, clean, light background */
  html, body { height: 100%; }
  body{
    margin: 0;
    background: var(--bg);
    color: var(--text);
  }

  /* Use the whole screen (16:9 display) */
  .wrap{
    width: min(1800px, 100vw);
    height: 100vh;
    margin: 0 auto;
    padding: clamp(16px, 2vw, 28px);
    display: grid;
    gap: clamp(14px, 1.6vw, 22px);
    box-sizing: border-box;
    align-content: start;
  }

  .topbar{
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 16px;
    align-items: center;
    padding: clamp(16px, 1.8vw, 22px);
    border: 1px solid var(--border);
    border-radius: 18px;
    background: var(--card);
  }

  .title{ display: grid; gap: 6px; }
  .title h1{
    font-size: clamp(22px, 2vw, 30px);
    margin: 0;
    letter-spacing: .2px;
    font-weight: 800;
  }
  .title .sub{
    font-size: clamp(14px, 1.2vw, 18px);
    color: var(--muted);
  }

  .controls{ display:flex; gap: 12px; align-items:center; }
  select, button{
    border-radius: 14px;
    border: 1px solid var(--border);
    background: #ffffff;
    color: var(--text);
    padding: 12px 14px;
    font-size: clamp(14px, 1.1vw, 18px);
    outline: none;
  }
  button{ cursor:pointer; }
  button:hover{ background: rgba(37,99,235,.06); border-color: rgba(37,99,235,.22); }

  /* Big board layout */
  .grid{
    display: grid;
    grid-template-columns: 2.2fr 1fr;
    gap: clamp(14px, 1.6vw, 22px);
    align-items: stretch;
    min-height: 0;
  }

  /* Keep 2 columns on most displays; only collapse on small devices */
  @media (max-width: 900px){
    .wrap{ height: auto; }
    .grid{ grid-template-columns: 1fr; }
  }

  .card{
    border: 1px solid var(--border);
    border-radius: 22px;
    background: var(--card);
    padding: clamp(18px, 2vw, 28px);
    box-sizing: border-box;
  }

  /* Current card */
  .current{
    border-color: rgba(37,99,235,.25);
    box-shadow: 0 10px 30px rgba(15, 23, 42, .08);
    display: grid;
    grid-template-rows: auto 1fr auto;
    gap: clamp(14px, 1.6vw, 22px);
    min-height: 0;
  }

  .badge{
    display: inline-flex;
    align-items: center;
    gap: 10px;
    font-size: clamp(13px, 1.0vw, 16px);
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 999px;
    background: rgba(37,99,235,.06);
    color: var(--muted);
  }
  .badge strong{ color: var(--text); font-weight: 750; }

  /* Clubs = PRIMARY content */
  .clubs{
    display: grid;
    gap: 12px;
    align-content: start;
    min-height: 0;
  }

  .clubsTitle{
    font-size: clamp(16px, 1.2vw, 20px);
    color: var(--muted);
    font-weight: 650;
  }

  .clubList{
    display: grid;
    gap: clamp(12px, 1.2vw, 16px);
    min-height: 0;
  }

  .pill{
    border: 1px solid rgba(37,99,235,.22);
    background: rgba(37,99,235,.07);
    border-radius: 18px;
    padding: clamp(16px, 1.6vw, 22px);
    font-weight: 900;
    font-size: clamp(26px, 2.6vw, 44px);
    line-height: 1.05;
  }

  /* Time becomes secondary */
  .metaRow{
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 16px;
    align-items: end;
    padding-top: 8px;
    border-top: 1px dashed rgba(15, 23, 42, .12);
  }

  .bigTime{
    font-size: clamp(24px, 2.2vw, 40px);
    font-weight: 850;
    letter-spacing: .2px;
  }
  .bigRange{
    font-size: clamp(14px, 1.2vw, 18px);
    color: var(--muted);
    margin-top: 4px;
  }

  .bigRemain{ text-align:right; }
  .bigRemain .mins{
    font-size: clamp(28px, 2.6vw, 48px);
    font-weight: 900;
    color: var(--ok);
  }
  .bigRemain .lbl{
    font-size: clamp(12px, 1.0vw, 16px);
    color: var(--muted);
  }

  /* Next / Arriving cards bigger */
  .sideCol{
    display: grid;
    gap: clamp(14px, 1.6vw, 22px);
    height: 100%;
  }

  .smallHead{
    display:flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 10px;
    margin-bottom: 14px;
  }
  .smallHead .label{
    font-size: clamp(14px, 1.1vw, 18px);
    color: var(--muted);
    font-weight: 750;
  }
  .smallHead .time{
    font-size: clamp(22px, 2.0vw, 34px);
    font-weight: 900;
  }

  .sidePill{
    border: 1px solid var(--border);
    background: rgba(15,23,42,.03);
    border-radius: 16px;
    padding: 14px 16px;
    font-weight: 800;
    font-size: clamp(18px, 1.6vw, 26px);
    line-height: 1.1;
  }

  .footer{
    font-size: clamp(12px, 1.0vw, 16px);
    color: var(--muted);
    display:flex;
    justify-content: space-between;
    gap: 10px;
    padding: 0 4px;
  }

  .mono{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
  .muted{ color: var(--muted); }
  .err{ color: #b91c1c; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Club Picture Day Queue</h1>
        <div class="sub">
          <span class="mono" id="nowClock">--:--:--</span>
          <span class="muted">•</span>
          <span id="status">Loading dates…</span>
        </div>
      </div>

      <div class="controls">
        <select id="dateSelect" title="Select Assigned Date" disabled>
          <option>Loading…</option>
        </select>
        <button id="refreshBtn" disabled>Refresh</button>
      </div>
    </div>

    <div class="grid">
      <div class="card current" id="currentCard">
        <span class="badge">Now: <strong id="currentLabel">—</strong></span>

        <div class="bigRow">
          <div>
            <div class="bigTime mono" id="currentTime">—</div>
            <div class="muted" id="currentRange">—</div>
          </div>
          <div class="bigRemain">
            <div class="mins mono" id="minsRemaining">—</div>
            <div class="lbl">minutes remaining</div>
          </div>
        </div>

        <div class="card current" id="currentCard">
          <span class="badge">Now: <strong id="currentLabel">—</strong></span>

          <!-- CLUBS FIRST (primary) -->
          <div class="clubs">
            <div class="clubsTitle">Clubs in this slot</div>
            <div class="clubList" id="currentClubs"></div>
          </div>

          <!-- TIME / REMAINING (secondary) -->
          <div class="metaRow">
            <div>
              <div class="bigTime mono" id="currentTime">—</div>
              <div class="bigRange" id="currentRange">—</div>
            </div>
            <div class="bigRemain">
              <div class="mins mono" id="minsRemaining">—</div>
              <div class="lbl">minutes remaining</div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:grid; gap:14px;" class="sideCol">
        <div class="card" id="nextCard">
          <div class="smallHead">
            <div class="label">Next</div>
            <div class="time mono" id="nextTime">—</div>
          </div>
          <div class="clubList" id="nextClubs"></div>
        </div>

        <div class="card" id="arrivingCard">
          <div class="smallHead">
            <div class="label">Arriving</div>
            <div class="time mono" id="arrivingTime">—</div>
          </div>
          <div class="clubList" id="arrivingClubs"></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Data source: Apps Script</div>
      <div class="mono" id="lastUpdated">Updated: —</div>
    </div>
  </div>

<script>
  // ✅ Replace with your deployed Apps Script Web App URL (ends with /exec)
  const API_BASE = "https://script.google.com/a/macros/bishopmoore.org/s/AKfycbxupx-ve0SwiESEanmV6jTkL6lL6kiD5uupE_lU1b20qVoaxahBWg6RNcByCPuDXUa_/exec";

  let schedule = {
    date: null,
    slots: [],
    defaultLastSlotMinutes: 10,
    lastUpdated: null
  };

  const els = {
    nowClock: document.getElementById('nowClock'),
    status: document.getElementById('status'),
    dateSelect: document.getElementById('dateSelect'),
    refreshBtn: document.getElementById('refreshBtn'),
    lastUpdated: document.getElementById('lastUpdated'),

    currentLabel: document.getElementById('currentLabel'),
    currentTime: document.getElementById('currentTime'),
    currentRange: document.getElementById('currentRange'),
    minsRemaining: document.getElementById('minsRemaining'),
    currentClubs: document.getElementById('currentClubs'),

    nextTime: document.getElementById('nextTime'),
    nextClubs: document.getElementById('nextClubs'),

    arrivingTime: document.getElementById('arrivingTime'),
    arrivingClubs: document.getElementById('arrivingClubs'),
  };

  function pad2(n){ return String(n).padStart(2,'0'); }

  function fmtClock(d){
    let h = d.getHours(), m = d.getMinutes(), s = d.getSeconds();
    const ap = h >= 12 ? 'PM' : 'AM';
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${pad2(m)}:${pad2(s)} ${ap}`;
  }

  function minutesNow(){
    const d = new Date();
    return d.getHours() * 60 + d.getMinutes() + (d.getSeconds()/60);
  }

  function minToLabel(mins){
    const hh24 = Math.floor(mins / 60);
    const mm = Math.floor(mins % 60);
    let hh12 = hh24 % 12; if (hh12 === 0) hh12 = 12;
    const ap = hh24 >= 12 ? 'PM' : 'AM';
    return `${hh12}:${pad2(mm)} ${ap}`;
  }

  function clearNode(node){ while(node.firstChild) node.removeChild(node.firstChild); }

  function pills(node, clubs){
    clearNode(node);
    if (!clubs || clubs.length === 0){
      const span = document.createElement('div');
      span.className = 'muted';
      span.textContent = '—';
      node.appendChild(span);
      return;
    }
    clubs.forEach(c => {
      const p = document.createElement('div');
      p.className = 'pill';
      p.textContent = c;
      node.appendChild(p);
    });
  }

  function pillsSide(node, clubs){
    clearNode(node);
    if (!clubs || clubs.length === 0){
      const span = document.createElement('div');
      span.className = 'muted';
      span.textContent = '—';
      node.appendChild(span);
      return;
    }
    clubs.forEach(c => {
      const p = document.createElement('div');
      p.className = 'sidePill';
      p.textContent = c;
      node.appendChild(p);
    });
  }

  function computeIndices(){
    const now = minutesNow();
    const slots = schedule.slots || [];
    if (slots.length === 0) return { currentIdx: -1, nextIdx: -1, arrivingIdx: -1, endMinutes: null };

    // Find last slot whose start <= now
    let idx = -1;
    for (let i = 0; i < slots.length; i++){
      if (slots[i].timeMinutes <= now) idx = i;
      else break;
    }

    // Before first slot: "current" is none, next is first, arriving is second
    if (idx === -1){
      return { currentIdx: -1, nextIdx: 0, arrivingIdx: slots.length > 1 ? 1 : -1, endMinutes: null };
    }

    // Determine end of current slot: next slot start OR default duration for last slot
    let end;
    if (idx < slots.length - 1) end = slots[idx + 1].timeMinutes;
    else end = slots[idx].timeMinutes + schedule.defaultLastSlotMinutes;

    // If we're past the computed end (e.g. large gap + default too small), treat as no current.
    if (now >= end){
      const next = idx + 1 < slots.length ? idx + 1 : -1;
      const arr = idx + 2 < slots.length ? idx + 2 : -1;
      return { currentIdx: -1, nextIdx: next, arrivingIdx: arr, endMinutes: null };
    }

    return {
      currentIdx: idx,
      nextIdx: idx + 1 < slots.length ? idx + 1 : -1,
      arrivingIdx: idx + 2 < slots.length ? idx + 2 : -1,
      endMinutes: end
    };
  }

  function render(){
    const { currentIdx, nextIdx, arrivingIdx, endMinutes } = computeIndices();
    const slots = schedule.slots || [];
    const now = minutesNow();

    // CURRENT
    if (currentIdx === -1){
      els.currentLabel.textContent = 'No active slot';
      els.currentTime.textContent = '—';
      els.currentRange.textContent = (nextIdx !== -1)
        ? `Next begins at ${slots[nextIdx].timeLabel}`
        : 'No more scheduled slots';
      els.minsRemaining.textContent = '—';
      pills(els.currentClubs, []);
    } else {
      const cur = slots[currentIdx];
      els.currentLabel.textContent = schedule.date || 'Selected date';
      els.currentTime.textContent = cur.timeLabel;

      const endLabel = minToLabel(endMinutes);
      els.currentRange.textContent = `Until ${endLabel}`;

      const minsLeft = Math.max(0, Math.ceil((endMinutes - now)));
      els.minsRemaining.textContent = String(minsLeft);

      pillsSide(els.nextClubs, nxt.clubs);
    }

    // NEXT
    if (nextIdx === -1){
      els.nextTime.textContent = '—';
      pills(els.nextClubs, []);
    } else {
      const nxt = slots[nextIdx];
      els.nextTime.textContent = nxt.timeLabel;
      pills(els.nextClubs, nxt.clubs);
    }

    // ARRIVING
    if (arrivingIdx === -1){
      els.arrivingTime.textContent = '—';
      pillsSide(els.arrivingClubs, arr.clubs);
    } else {
      const arr = slots[arrivingIdx];
      els.arrivingTime.textContent = arr.timeLabel;
      pillsSide(els.arrivingClubs, arr.clubs);
    }

    // footer
    els.lastUpdated.textContent = `Updated: ${schedule.lastUpdated ? schedule.lastUpdated : '—'}`;
  }

  async function fetchJSON(url){
    const res = await fetch(url, { cache: "no-store" });
    const data = await res.json();
    if (!res.ok || !data.ok) {
      throw new Error(data && data.error ? data.error : `HTTP ${res.status}`);
    }
    return data;
  }

  async function loadDates(){
    els.status.textContent = "Loading dates…";
    const meta = await fetchJSON(`${API_BASE}?mode=meta`);
    const dates = meta.dates || [];

    clearNode(els.dateSelect);
    if (dates.length === 0){
      const opt = document.createElement('option');
      opt.textContent = "No dates found";
      els.dateSelect.appendChild(opt);
      els.dateSelect.disabled = true;
      els.refreshBtn.disabled = true;
      els.status.innerHTML = `<span class="err">No Assigned Dates found in sheet "Info" (col F).</span>`;
      return;
    }

    dates.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      els.dateSelect.appendChild(opt);
    });

    els.dateSelect.disabled = false;
    els.refreshBtn.disabled = false;

    // default to first date (or persist last selection)
    const saved = localStorage.getItem("bmc_display_date");
    if (saved && dates.includes(saved)) els.dateSelect.value = saved;

    els.status.textContent = "Loading schedule…";
    await loadScheduleForSelectedDate();
  }

  async function loadScheduleForSelectedDate(){
    const date = els.dateSelect.value;
    localStorage.setItem("bmc_display_date", date);

    els.status.textContent = `Loading schedule for ${date}…`;
    const data = await fetchJSON(`${API_BASE}?date=${encodeURIComponent(date)}`);

    schedule.date = data.date;
    schedule.slots = data.slots || [];
    schedule.defaultLastSlotMinutes = data.defaultLastSlotMinutes || 10;
    schedule.lastUpdated = new Date().toLocaleString();

    els.status.textContent = `Loaded ${schedule.slots.length} slot(s) for ${date}`;
    render();
  }

  // Clock + countdown tick
  setInterval(() => {
    els.nowClock.textContent = fmtClock(new Date());
    render();
  }, 1000);

  // Periodic data refresh (keeps clubs updated if sheet changes)
  setInterval(() => {
    if (!els.dateSelect.disabled) loadScheduleForSelectedDate().catch(() => {});
  }, 60000);

  els.dateSelect.addEventListener('change', () => {
    loadScheduleForSelectedDate().catch(err => {
      els.status.innerHTML = `<span class="err">${err.message}</span>`;
    });
  });

  els.refreshBtn.addEventListener('click', () => {
    loadScheduleForSelectedDate().catch(err => {
      els.status.innerHTML = `<span class="err">${err.message}</span>`;
    });
  });

  // Init
  (async function init(){
    try {
      if (!API_BASE || API_BASE.includes("YOUR_WEB_APP_URL_HERE")) {
        els.status.innerHTML = `<span class="err">Set API_BASE to your Apps Script Web App URL.</span>`;
        return;
      }
      await loadDates();
    } catch (err) {
      els.status.innerHTML = `<span class="err">${err.message}</span>`;
    }
  })();
</script>
</body>
</html>
