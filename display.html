<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Club Picture Day Queue Display</title>
  <style>
    :root{
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: rgba(15, 23, 42, .12);
      --text: rgba(15, 23, 42, .92);
      --muted: rgba(15, 23, 42, .62);
      --accent: #FFD180;
      --ok: #16a34a;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    /* Full-screen, 16:9-friendly */
    .wrap{
      width: min(1800px, 100vw);
      height: 100vh;
      margin: 0 auto;
      padding: clamp(16px, 2vw, 28px);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: clamp(14px, 1.6vw, 22px);
      box-sizing: border-box;
    }

    .topbar{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: center;
      padding: clamp(16px, 1.8vw, 22px);
      border: 1px solid var(--border);
      border-radius: 18px;
      background: var(--card);
    }

    .title{ display: grid; gap: 6px; }
    .title h1{
      font-size: clamp(22px, 2vw, 30px);
      margin: 0;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .title .sub{
      font-size: clamp(14px, 1.2vw, 18px);
      color: var(--muted);
    }

    .controls{ display:flex; gap: 12px; align-items:center; }
    select, button{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      padding: 12px 14px;
      font-size: clamp(14px, 1.1vw, 18px);
      outline: none;
    }
    button{ cursor:pointer; }
    button:hover{ background: rgba(37,99,235,.06); border-color: rgba(37,99,235,.22); }

    .card{
      border: 1px solid var(--border);
      border-radius: 22px;
      background: var(--card);
      padding: clamp(18px, 2vw, 28px);
      box-sizing: border-box;
    }

    /* BOARD: big current (>=70% height) + ticker */
    .board{
      display: grid;
      grid-template-rows: 1fr auto;
      gap: clamp(14px, 1.6vw, 22px);
      min-height: 0;
    }

    .current{
      border-color: var(--muted);
      box-shadow: 0 10px 30px rgba(15, 23, 42, .08);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: clamp(14px, 1.6vw, 22px);
      min-height: 0;
    }

    .badge{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: clamp(13px, 1.0vw, 16px);
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(37,99,235,.06);
      color: var(--muted);
      width: fit-content;
    }
    .badge strong{ color: var(--text); font-weight: 800; }

    .clubs{
      display: grid;
      gap: 12px;
      align-content: start;
      min-height: 0;
    }
    .clubsTitle{
      font-size: clamp(16px, 1.2vw, 20px);
      color: var(--muted);
      font-weight: 700;
    }

    /* Big, TV-readable club list */
    .clubList{
      display: grid;
      gap: clamp(14px, 1.6vw, 22px);
      align-content: start;
      min-height: 0;
    }

    .pill{
      border: 1px solid var(--accent);
      background: var(--accent);
      border-radius: 22px;
      padding: clamp(18px, 2.1vw, 30px);
      font-weight: 950;
      font-size: clamp(34px, 4.2vw, 72px);
      line-height: 1.05;
      word-break: break-word;
    }

    .metaRow{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: end;
      padding-top: 10px;
      border-top: 1px dashed rgba(15, 23, 42, .12);
    }

    .bigTime{
      font-size: clamp(22px, 2.2vw, 38px);
      font-weight: 900;
      letter-spacing: .2px;
    }
    .bigRange{
      font-size: clamp(14px, 1.2vw, 18px);
      color: var(--muted);
      margin-top: 4px;
    }

    .bigRemain{ text-align:right; }
    .bigRemain .mins{
      font-size: clamp(28px, 3.2vw, 64px);
      font-weight: 950;
      color: var(--ok);
      line-height: 1;
    }
    .bigRemain .lbl{
      font-size: clamp(12px, 1.0vw, 16px);
      color: var(--muted);
      margin-top: 6px;
    }

    /* TICKER */
    .ticker{
      display: grid;
      grid-template-columns: max-content 1fr;
      align-items: center;
      gap: 14px;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 18px;
      padding: 12px 14px;
      overflow: hidden;
      align-items: center;
    }

    /* Left fixed "Next" area — auto sized */
    .tickerLeft{
      display: inline-grid;
      grid-auto-flow: column;
      grid-auto-columns: max-content;
      align-items: center;
      gap: 12px;
      padding-right: 14px;
      border-right: 1px solid var(--border);
      white-space: nowrap;
    }

    /* Holds the Next club chips */
    .tickerFixed{
      display: inline-flex;
      gap: 10px;
      align-items: center;
      white-space: nowrap;
    }

    /* Right scrolling area */
    .tickerRight{
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .tickerLabel{
      font-weight: 900;
      color: var(--muted);
      font-size: clamp(14px, 1.4vw, 18px);
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(15,23,42,.03);
      white-space: nowrap;
    }

    .tickerViewport{ overflow: hidden; width: 100%; }
    .tickerTrack{
      display: inline-flex;
      gap: 14px;
      align-items: center;
      white-space: nowrap;
      will-change: transform;
      animation: tickerMove linear infinite;
      animation-duration: var(--ticker-speed, 45s);
    }

    .tickerItem{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,.03);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: clamp(18px, 1.8vw, 26px);
      font-weight: 850;
    }

    .tickerTime{
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1;
      font-weight: 950;
      color: var(--text);
    }

    .tickerSep{ opacity: .45; }

    @keyframes tickerMove{
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    /* Mobile: stack if needed */
    @media (max-width: 900px){
      .ticker{
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .tickerLeft{
        border-right: none;
        padding-right: 0;
        min-width: 0;
      }
    }

    .footer{
      font-size: clamp(12px, 1.0vw, 16px);
      color: var(--muted);
      display:flex;
      justify-content: space-between;
      gap: 10px;
      padding: 0 4px;
    }

    .mono{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
    .muted{ color: var(--muted); }
    .err{ color: #b91c1c; }

    /* Fullscreen video modal overlay (fade in/out) */
    .videoModal{
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: #000;

      /* keep it mounted so opacity can animate */
      display: grid;
      place-items: center;

      opacity: 0;
      pointer-events: none;
      transition: opacity 500ms ease;
    }

    .videoModal.show{
      opacity: 1;
      pointer-events: auto;
    }

    .videoModalInner{
      width: 100vw;
      height: 100vh;
    }

    .videoModal video{
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }
  
/* --- Multi-club layout + auto scaling (Current Photographing card) --- */
.clubList{
  display: grid;
  grid-template-columns: 1fr;
}

.clubList.count-3,
.clubList.count-4,
.clubList.count-4plus{
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: clamp(12px, 1.2vw, 18px);
}

.pill{
  border: 1px solid var(--accent);
  background: var(--accent);
  border-radius: 22px;
  padding: clamp(18px, 2.1vw, 30px);
  font-weight: 950;
  font-size: clamp(34px, 4.2vw, 72px);
  line-height: 1.05;
  word-break: break-word;
}

.clubList.count-1 .pill{
  font-size: clamp(44px, 5.0vw, 84px);
  padding: clamp(22px, 2.4vw, 34px);
}

.clubList.count-2 .pill{
  font-size: clamp(38px, 4.4vw, 76px);
  padding: clamp(20px, 2.2vw, 32px);
}

.clubList.count-3 .pill{
  font-size: clamp(30px, 3.2vw, 56px);
  padding: clamp(16px, 1.6vw, 24px);
  line-height: 1.08;
}

.clubList.count-4 .pill,
.clubList.count-4plus .pill{
  font-size: clamp(26px, 2.6vw, 46px);
  padding: clamp(14px, 1.4vw, 22px);
  line-height: 1.10;
}

</style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Club Picture Day Queue</h1>
        <div class="sub">
          <span class="mono" id="nowClock">--:--:--</span>
          <span class="muted">•</span>
          <span id="status">Loading dates…</span>
        </div>
      </div>

      <div class="controls">
        <select id="dateSelect" title="Select Assigned Date" disabled>
          <option>Loading…</option>
        </select>
        <button id="refreshBtn" disabled>Refresh</button>
      </div>
    </div>

    <div class="board">
      <!-- CURRENT (big, full width) -->
      <div class="card current" id="currentCard">
        <span class="badge">Now: <strong id="currentLabel">—</strong></span>

        <div class="clubs">
          <div class="clubsTitle">Clubs Photographing Now:</div>
          <div class="clubList" id="currentClubs"></div>
        </div>

        <div class="metaRow">
          <div>
            <div class="bigTime mono" id="currentTime">—</div>
            <div class="bigRange" id="currentRange">—</div>
          </div>
          <div class="bigRemain">
            <div class="mins mono" id="minsRemaining">—</div>
            <div class="lbl">minutes remaining</div>
          </div>
        </div>
      </div>

      <!-- TICKER (bottom) -->
      <div class="ticker" aria-label="Upcoming slots">
        <div class="tickerLeft">
          <div class="tickerLabel">Next</div>
          <div class="tickerFixed" id="tickerNextFixed">
            <div class="tickerItem muted">—</div>
          </div>
        </div>

        <div class="tickerRight">
          <div class="tickerLabel">Arriving</div>
          <div class="tickerViewport">
            <div class="tickerTrack" id="tickerTrack">
              <div class="tickerItem muted">Loading…</div>
            </div>
          </div>
        </div>
      </div>


    <div class="footer">
      <div>Data source: Apps Script</div>
      <div class="mono" id="lastUpdated">Updated: —</div>
    </div>
  </div>

  <!-- Fullscreen Instructions Video Modal -->
  <div id="videoModal" class="videoModal" aria-hidden="true">
    <div class="videoModalInner">
      <video id="instructionVideo" playsinline preload="auto" muted>
        <source src="https://github.com/Bishop-Moore-Catholic/SitCard/raw/refs/heads/main/Instructions.mp4" type="video/mp4">
      </video>
    </div>
  </div>

<script>
  // Your Apps Script Web App URL (ends with /exec)
  const API_BASE = "https://script.google.com/a/macros/bishopmoore.org/s/AKfycbxupx-ve0SwiESEanmV6jTkL6lL6kiD5uupE_lU1b20qVoaxahBWg6RNcByCPuDXUa_/exec";

  let schedule = {
    date: null,
    slots: [],
    defaultLastSlotMinutes: 10,
    lastUpdated: null
  };

  const els = {
    nowClock: document.getElementById('nowClock'),
    status: document.getElementById('status'),
    dateSelect: document.getElementById('dateSelect'),
    refreshBtn: document.getElementById('refreshBtn'),
    lastUpdated: document.getElementById('lastUpdated'),

    currentLabel: document.getElementById('currentLabel'),
    currentTime: document.getElementById('currentTime'),
    currentRange: document.getElementById('currentRange'),
    minsRemaining: document.getElementById('minsRemaining'),
    currentClubs: document.getElementById('currentClubs'),

    tickerTrack: document.getElementById('tickerTrack'),
  };

  function getQueryParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}


  function pad2(n){ return String(n).padStart(2,'0'); }

  function fmtClock(d){
    let h = d.getHours(), m = d.getMinutes(), s = d.getSeconds();
    const ap = h >= 12 ? 'PM' : 'AM';
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${pad2(m)}:${pad2(s)} ${ap}`;
  }

  function minutesNow(){
    const d = new Date();
    return d.getHours() * 60 + d.getMinutes() + (d.getSeconds()/60);
  }

  function minToLabel(mins){
    const hh24 = Math.floor(mins / 60);
    const mm = Math.floor(mins % 60);
    let hh12 = hh24 % 12; if (hh12 === 0) hh12 = 12;
    const ap = hh24 >= 12 ? 'PM' : 'AM';
    return `${hh12}:${pad2(mm)} ${ap}`;
  }

  function clearNode(node){ while(node.firstChild) node.removeChild(node.firstChild); }

  
function pills(node, clubs){
  clearNode(node);

  node.classList.remove("count-0","count-1","count-2","count-3","count-4","count-4plus");

  const list = Array.isArray(clubs) ? clubs.filter(Boolean) : [];
  const count = list.length;

  if (count <= 0) node.classList.add("count-0");
  else if (count === 1) node.classList.add("count-1");
  else if (count === 2) node.classList.add("count-2");
  else if (count === 3) node.classList.add("count-3");
  else if (count === 4) node.classList.add("count-4");
  else node.classList.add("count-4plus");

  if (count === 0){
    const span = document.createElement('div');
    span.className = 'muted';
    span.textContent = '—';
    node.appendChild(span);
    return;
  }

  const show = list.slice(0, 4);
  show.forEach(c => {
    const p = document.createElement('div');
    p.className = 'pill';
    p.textContent = c;
    node.appendChild(p);
  });

  const extra = count - show.length;
  if (extra > 0){
    const p = document.createElement('div');
    p.className = 'pill';
    p.textContent = `+${extra} more`;
    node.appendChild(p);
  }
}

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function buildTickerItems(slots, startIdx){
    const items = [];
    for (let i = Math.max(0, startIdx); i < slots.length; i++){
      const slot = slots[i];
      const clubs = (slot.clubs || []).join(", ");
      items.push({ time: slot.timeLabel, text: clubs || "—" });
    }
    return items;
  }

  function renderNextFixed(nextSlot){
    const box = document.getElementById("tickerNextFixed");
    if (!box) return;

    if (!nextSlot){
      box.innerHTML = `<div class="tickerItem muted">—</div>`;
      return;
    }

    // Show time + each club as separate chips (or one chip if you prefer)
    const clubs = nextSlot.clubs || [];
    const chips = clubs.length
      ? clubs.map(c => `
          <div class="tickerItem">
            <span class="tickerTime">${escapeHTML(nextSlot.timeLabel)}</span>
            <span class="tickerSep">•</span>
            <span>${escapeHTML(c)}</span>
          </div>
        `).join("")
      : `<div class="tickerItem"><span class="tickerTime">${escapeHTML(nextSlot.timeLabel)}</span><span class="tickerSep">•</span><span>—</span></div>`;

    box.innerHTML = chips;
  }

  function renderTicker(items){
    const track = els.tickerTrack;
    if (!track) return;

    if (!items || items.length === 0){
      track.innerHTML = `<div class="tickerItem muted">No more scheduled slots</div>`;
      track.style.animation = "none";
      return;
    }

    const htmlOnce = items.map(it => `
      <div class="tickerItem">
        <span class="tickerTime">${escapeHTML(it.time)}</span>
        <span class="tickerSep">•</span>
        <span>${escapeHTML(it.text)}</span>
      </div>
    `).join("");

    // Duplicate for seamless loop
    track.innerHTML = htmlOnce + htmlOnce;

    // Auto speed: longer content = slower
    const approxChars = items.reduce((sum, it) => sum + it.time.length + it.text.length + 6, 0);
    const seconds = Math.min(90, Math.max(28, approxChars * 0.18));
    track.style.setProperty("--ticker-speed", `${seconds}s`);

    // Ensure animation is on
    track.style.animation = "";
  }

  function computeIndices(){
    const now = minutesNow();
    const slots = schedule.slots || [];
    if (slots.length === 0) return { currentIdx: -1, nextIdx: -1, endMinutes: null };

    // Find last slot whose start <= now
    let idx = -1;
    for (let i = 0; i < slots.length; i++){
      if (slots[i].timeMinutes <= now) idx = i;
      else break;
    }

    // Before first slot
    if (idx === -1){
      return { currentIdx: -1, nextIdx: 0, endMinutes: null };
    }

    // End time: next slot start OR default duration for last slot
    let end;
    if (idx < slots.length - 1) end = slots[idx + 1].timeMinutes;
    else end = slots[idx].timeMinutes + schedule.defaultLastSlotMinutes;

    // If we've passed end, no active slot; next is idx+1
    if (now >= end){
      const next = idx + 1 < slots.length ? idx + 1 : -1;
      return { currentIdx: -1, nextIdx: next, endMinutes: null };
    }

    return {
      currentIdx: idx,
      nextIdx: idx + 1 < slots.length ? idx + 1 : -1,
      endMinutes: end
    };
  }

  function render(){
    const { currentIdx, nextIdx, endMinutes } = computeIndices();
    const slots = schedule.slots || [];
    const now = minutesNow();

    // CURRENT
    if (currentIdx === -1){
      els.currentLabel.textContent = 'No active slot';
      els.currentTime.textContent = '—';
      els.currentRange.textContent = (nextIdx !== -1)
        ? `Next begins at ${slots[nextIdx].timeLabel}`
        : 'No more scheduled slots';
      els.minsRemaining.textContent = '—';
      pills(els.currentClubs, []);
    } else {
      const cur = slots[currentIdx];
      els.currentLabel.textContent = schedule.date || 'Selected date';
      els.currentTime.textContent = cur.timeLabel;

      const endLabel = minToLabel(endMinutes);
      els.currentRange.textContent = `Until ${endLabel}`;

      const minsLeft = Math.max(0, Math.ceil((endMinutes - now)));
      els.minsRemaining.textContent = String(minsLeft);

      pills(els.currentClubs, cur.clubs);
    }

    // TICKER: everything from NEXT onward
    // FIXED NEXT (left)
    const nextSlot = (nextIdx !== -1) ? slots[nextIdx] : null;
    renderNextFixed(nextSlot);

    // SCROLLING ARRIVING+ (right) -> start AFTER next slot
    const startIdx = (nextIdx !== -1) ? nextIdx + 1 : -1;
    const tickerItems = (startIdx !== -1) ? buildTickerItems(slots, startIdx) : [];
    renderTicker(tickerItems);

    // Footer
    els.lastUpdated.textContent = `Updated: ${schedule.lastUpdated ? schedule.lastUpdated : '—'}`;
  }

  async function fetchJSON(url){
    const res = await fetch(url, { cache: "no-store" });
    const data = await res.json();
    if (!res.ok || !data.ok) {
      throw new Error(data && data.error ? data.error : `HTTP ${res.status}`);
    }
    return data;
  }

  async function loadDates(){
    els.status.textContent = "Loading dates…";
    const meta = await fetchJSON(`${API_BASE}?mode=meta`);
    const dates = meta.dates || [];

    // Populate dropdown
    els.dateSelect.innerHTML = "";
    if (dates.length === 0){
      const opt = document.createElement('option');
      opt.textContent = "No dates found";
      els.dateSelect.appendChild(opt);
      els.dateSelect.disabled = true;
      els.refreshBtn.disabled = true;
      els.status.innerHTML = `<span class="err">No Assigned Dates found in sheet "Info" (col F).</span>`;
      return;
    }

    dates.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      els.dateSelect.appendChild(opt);
    });

    els.dateSelect.disabled = false;
    els.refreshBtn.disabled = false;

    // Restore last selection if available
    const saved = localStorage.getItem("bmc_display_date");
    if (saved && dates.includes(saved)) els.dateSelect.value = saved;

    els.status.textContent = "Loading schedule…";
    await loadScheduleForSelectedDate();
  }

  async function loadScheduleForSelectedDate(){
    const date = els.dateSelect.value;
    localStorage.setItem("bmc_display_date", date);

    els.status.textContent = `Loading schedule for ${date}…`;
    const data = await fetchJSON(`${API_BASE}?date=${encodeURIComponent(date)}`);

    schedule.date = data.date;
    schedule.slots = data.slots || [];
    schedule.defaultLastSlotMinutes = data.defaultLastSlotMinutes || 10;
    schedule.lastUpdated = new Date().toLocaleString();

    els.status.textContent = `Loaded ${schedule.slots.length} slot(s) for ${date}`;
    render();
  }

  // Clock + countdown tick
  setInterval(() => {
    els.nowClock.textContent = fmtClock(new Date());
    render();
  }, 1000);

  // Periodic data refresh
  setInterval(() => {
    if (!els.dateSelect.disabled) loadScheduleForSelectedDate().catch(() => {});
  }, 60000);

  els.dateSelect.addEventListener('change', () => {
    loadScheduleForSelectedDate().catch(err => {
      els.status.innerHTML = `<span class="err">${err.message}</span>`;
    });
  });

  els.refreshBtn.addEventListener('click', () => {
    loadScheduleForSelectedDate().catch(err => {
      els.status.innerHTML = `<span class="err">${err.message}</span>`;
    });
  });

  (async function init(){
    try {
      if (!API_BASE) {
        els.status.innerHTML = `<span class="err">Set API_BASE to your Apps Script Web App URL.</span>`;
        return;
      }
      await loadDates();
    } catch (err) {
      els.status.innerHTML = `<span class="err">${err.message}</span>`;
    }
  })();

  // ---- Instructions Video Modal (plays once per minute) ----
  const INSTRUCTIONS_VIDEO_URL = "https://github.com/Bishop-Moore-Catholic/SitCard/raw/refs/heads/main/Instructions.mp4";

  const INSTRUCTIONS_INTERVAL_MS = 60_000;
  const INSTRUCTIONS_FIRST_DELAY_MS = 15_000;

  // fade timings (match CSS transition)
  const VIDEO_FADE_MS = 500;

  let isVideoPlaying = false;
  let lastVideoStart = 0;

  function setupInstructionsVideo(){
    // URL flag: ?video=0 disables the overlay
    const videoFlag = getQueryParam("video");
    if (videoFlag === "0") {
      console.log("Video overlay disabled via ?video=0");
      return;
    }

    const modal = document.getElementById("videoModal");
    const video = document.getElementById("instructionVideo");
    if (!modal || !video) return;

    // Ensure correct source
    const srcEl = video.querySelector("source");
    if (srcEl && srcEl.src !== INSTRUCTIONS_VIDEO_URL) {
      srcEl.src = INSTRUCTIONS_VIDEO_URL;
      video.load();
    }

    function showModal(){
      modal.classList.add("show");
      modal.setAttribute("aria-hidden", "false");
    }

    function hideModal(){
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden", "true");
    }

    function stopAndHide(){
      try { video.pause(); } catch (_) {}

      // Fade out first, then reset time so it doesn't flash the first frame
      hideModal();
      setTimeout(() => {
        try { video.currentTime = 0; } catch (_) {}
        isVideoPlaying = false;
      }, VIDEO_FADE_MS);
    }

    async function playOnce(){
      const now = Date.now();
      if (isVideoPlaying) return;

      // Guard so it can’t re-trigger while finishing
      if (now - lastVideoStart < 35_000) return; // video ~33s

      isVideoPlaying = true;
      lastVideoStart = now;

      // Start hidden -> fade in
      showModal();

      try {
        // Restart cleanly
        video.pause();
        video.currentTime = 0;

        // Attempt play (autoplay policies may apply)
        await video.play();
      } catch (err) {
        console.warn("Instruction video autoplay failed:", err);
        stopAndHide();
        return;
      }
    }

    // When video ends, fade out
    video.addEventListener("ended", () => stopAndHide());

    // If video errors, fade out
    video.addEventListener("error", () => {
      console.warn("Instruction video error.");
      stopAndHide();
    });

    // Optional: ESC closes (useful while testing)
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && isVideoPlaying) stopAndHide();
    });

    // Schedule playback
    setTimeout(() => {
      playOnce();
      setInterval(playOnce, INSTRUCTIONS_INTERVAL_MS);
    }, INSTRUCTIONS_FIRST_DELAY_MS);
  }

  setupInstructionsVideo();
</script>
</body>
</html>
