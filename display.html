<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Club Picture Day Queue Display</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.09);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --accent: #4fb3ff;
      --ok: #32d583;
      --warn: #fdb022;

      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body { margin: 0; background: radial-gradient(1200px 600px at 20% 10%, rgba(79,179,255,.25), transparent 60%), var(--bg); color: var(--text); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; display: grid; gap: 14px; }
    .topbar {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
    }
    .title { display: grid; gap: 2px; }
    .title h1 { font-size: 18px; margin: 0; letter-spacing: .2px; }
    .title .sub { font-size: 13px; color: var(--muted); }

    .controls { display: flex; gap: 10px; align-items: center; }
    select, button {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    button { cursor: pointer; }
    button:hover { background: rgba(255,255,255,.10); }

    .grid {
      display: grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 14px;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: var(--card);
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    /* BIG CURRENT */
    .current {
      background: linear-gradient(180deg, rgba(79,179,255,.18), rgba(255,255,255,.04));
      border-color: rgba(79,179,255,.35);
      padding: 18px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .badge strong { color: var(--text); font-weight: 650; }

    .bigRow {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-top: 12px;
    }
    .bigTime { font-size: 44px; font-weight: 800; letter-spacing: .2px; }
    .bigRemain { text-align: right; }
    .bigRemain .mins { font-size: 34px; font-weight: 800; color: var(--ok); }
    .bigRemain .lbl { font-size: 12px; color: var(--muted); }

    .clubs {
      margin-top: 12px;
      display: grid;
      gap: 10px;
    }
    .clubList {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .pill {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 650;
      font-size: 16px;
      line-height: 1;
    }

    /* Next / Arriving */
    .smallHead {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 10px;
    }
    .smallHead .label { font-size: 12px; color: var(--muted); }
    .smallHead .time { font-size: 22px; font-weight: 800; }

    .muted { color: var(--muted); }
    .err { color: #ff7b7b; }
    .footer {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 0 2px;
    }
    .mono { font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Club Picture Day Queue</h1>
        <div class="sub">
          <span class="mono" id="nowClock">--:--:--</span>
          <span class="muted">•</span>
          <span id="status">Loading dates…</span>
        </div>
      </div>

      <div class="controls">
        <select id="dateSelect" title="Select Assigned Date" disabled>
          <option>Loading…</option>
        </select>
        <button id="refreshBtn" disabled>Refresh</button>
      </div>
    </div>

    <div class="grid">
      <div class="card current" id="currentCard">
        <span class="badge">Now: <strong id="currentLabel">—</strong></span>

        <div class="bigRow">
          <div>
            <div class="bigTime mono" id="currentTime">—</div>
            <div class="muted" id="currentRange">—</div>
          </div>
          <div class="bigRemain">
            <div class="mins mono" id="minsRemaining">—</div>
            <div class="lbl">minutes remaining</div>
          </div>
        </div>

        <div class="clubs">
          <div class="muted">Clubs in this slot</div>
          <div class="clubList" id="currentClubs"></div>
        </div>
      </div>

      <div style="display:grid; gap:14px;">
        <div class="card" id="nextCard">
          <div class="smallHead">
            <div class="label">Next</div>
            <div class="time mono" id="nextTime">—</div>
          </div>
          <div class="clubList" id="nextClubs"></div>
        </div>

        <div class="card" id="arrivingCard">
          <div class="smallHead">
            <div class="label">Arriving</div>
            <div class="time mono" id="arrivingTime">—</div>
          </div>
          <div class="clubList" id="arrivingClubs"></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Data source: Apps Script</div>
      <div class="mono" id="lastUpdated">Updated: —</div>
    </div>
  </div>

<script>
  // ✅ Replace with your deployed Apps Script Web App URL (ends with /exec)
  const API_BASE = "https://script.google.com/a/macros/bishopmoore.org/s/AKfycbxupx-ve0SwiESEanmV6jTkL6lL6kiD5uupE_lU1b20qVoaxahBWg6RNcByCPuDXUa_/exec";

  let schedule = {
    date: null,
    slots: [],
    defaultLastSlotMinutes: 10,
    lastUpdated: null
  };

  const els = {
    nowClock: document.getElementById('nowClock'),
    status: document.getElementById('status'),
    dateSelect: document.getElementById('dateSelect'),
    refreshBtn: document.getElementById('refreshBtn'),
    lastUpdated: document.getElementById('lastUpdated'),

    currentLabel: document.getElementById('currentLabel'),
    currentTime: document.getElementById('currentTime'),
    currentRange: document.getElementById('currentRange'),
    minsRemaining: document.getElementById('minsRemaining'),
    currentClubs: document.getElementById('currentClubs'),

    nextTime: document.getElementById('nextTime'),
    nextClubs: document.getElementById('nextClubs'),

    arrivingTime: document.getElementById('arrivingTime'),
    arrivingClubs: document.getElementById('arrivingClubs'),
  };

  function pad2(n){ return String(n).padStart(2,'0'); }

  function fmtClock(d){
    let h = d.getHours(), m = d.getMinutes(), s = d.getSeconds();
    const ap = h >= 12 ? 'PM' : 'AM';
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${pad2(m)}:${pad2(s)} ${ap}`;
  }

  function minutesNow(){
    const d = new Date();
    return d.getHours() * 60 + d.getMinutes() + (d.getSeconds()/60);
  }

  function minToLabel(mins){
    const hh24 = Math.floor(mins / 60);
    const mm = Math.floor(mins % 60);
    let hh12 = hh24 % 12; if (hh12 === 0) hh12 = 12;
    const ap = hh24 >= 12 ? 'PM' : 'AM';
    return `${hh12}:${pad2(mm)} ${ap}`;
  }

  function clearNode(node){ while(node.firstChild) node.removeChild(node.firstChild); }

  function pills(node, clubs){
    clearNode(node);
    if (!clubs || clubs.length === 0){
      const span = document.createElement('div');
      span.className = 'muted';
      span.textContent = '—';
      node.appendChild(span);
      return;
    }
    clubs.forEach(c => {
      const p = document.createElement('div');
      p.className = 'pill';
      p.textContent = c;
      node.appendChild(p);
    });
  }

  function computeIndices(){
    const now = minutesNow();
    const slots = schedule.slots || [];
    if (slots.length === 0) return { currentIdx: -1, nextIdx: -1, arrivingIdx: -1, endMinutes: null };

    // Find last slot whose start <= now
    let idx = -1;
    for (let i = 0; i < slots.length; i++){
      if (slots[i].timeMinutes <= now) idx = i;
      else break;
    }

    // Before first slot: "current" is none, next is first, arriving is second
    if (idx === -1){
      return { currentIdx: -1, nextIdx: 0, arrivingIdx: slots.length > 1 ? 1 : -1, endMinutes: null };
    }

    // Determine end of current slot: next slot start OR default duration for last slot
    let end;
    if (idx < slots.length - 1) end = slots[idx + 1].timeMinutes;
    else end = slots[idx].timeMinutes + schedule.defaultLastSlotMinutes;

    // If we're past the computed end (e.g. large gap + default too small), treat as no current.
    if (now >= end){
      const next = idx + 1 < slots.length ? idx + 1 : -1;
      const arr = idx + 2 < slots.length ? idx + 2 : -1;
      return { currentIdx: -1, nextIdx: next, arrivingIdx: arr, endMinutes: null };
    }

    return {
      currentIdx: idx,
      nextIdx: idx + 1 < slots.length ? idx + 1 : -1,
      arrivingIdx: idx + 2 < slots.length ? idx + 2 : -1,
      endMinutes: end
    };
  }

  function render(){
    const { currentIdx, nextIdx, arrivingIdx, endMinutes } = computeIndices();
    const slots = schedule.slots || [];
    const now = minutesNow();

    // CURRENT
    if (currentIdx === -1){
      els.currentLabel.textContent = 'No active slot';
      els.currentTime.textContent = '—';
      els.currentRange.textContent = (nextIdx !== -1)
        ? `Next begins at ${slots[nextIdx].timeLabel}`
        : 'No more scheduled slots';
      els.minsRemaining.textContent = '—';
      pills(els.currentClubs, []);
    } else {
      const cur = slots[currentIdx];
      els.currentLabel.textContent = schedule.date || 'Selected date';
      els.currentTime.textContent = cur.timeLabel;

      const endLabel = minToLabel(endMinutes);
      els.currentRange.textContent = `Until ${endLabel}`;

      const minsLeft = Math.max(0, Math.ceil((endMinutes - now)));
      els.minsRemaining.textContent = String(minsLeft);

      pills(els.currentClubs, cur.clubs);
    }

    // NEXT
    if (nextIdx === -1){
      els.nextTime.textContent = '—';
      pills(els.nextClubs, []);
    } else {
      const nxt = slots[nextIdx];
      els.nextTime.textContent = nxt.timeLabel;
      pills(els.nextClubs, nxt.clubs);
    }

    // ARRIVING
    if (arrivingIdx === -1){
      els.arrivingTime.textContent = '—';
      pills(els.arrivingClubs, []);
    } else {
      const arr = slots[arrivingIdx];
      els.arrivingTime.textContent = arr.timeLabel;
      pills(els.arrivingClubs, arr.clubs);
    }

    // footer
    els.lastUpdated.textContent = `Updated: ${schedule.lastUpdated ? schedule.lastUpdated : '—'}`;
  }

  async function fetchJSON(url){
    const res = await fetch(url, { cache: "no-store" });
    const data = await res.json();
    if (!res.ok || !data.ok) {
      throw new Error(data && data.error ? data.error : `HTTP ${res.status}`);
    }
    return data;
  }

  async function loadDates(){
    els.status.textContent = "Loading dates…";
    const meta = await fetchJSON(`${API_BASE}?mode=meta`);
    const dates = meta.dates || [];

    clearNode(els.dateSelect);
    if (dates.length === 0){
      const opt = document.createElement('option');
      opt.textContent = "No dates found";
      els.dateSelect.appendChild(opt);
      els.dateSelect.disabled = true;
      els.refreshBtn.disabled = true;
      els.status.innerHTML = `<span class="err">No Assigned Dates found in sheet "Info" (col F).</span>`;
      return;
    }

    dates.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      els.dateSelect.appendChild(opt);
    });

    els.dateSelect.disabled = false;
    els.refreshBtn.disabled = false;

    // default to first date (or persist last selection)
    const saved = localStorage.getItem("bmc_display_date");
    if (saved && dates.includes(saved)) els.dateSelect.value = saved;

    els.status.textContent = "Loading schedule…";
    await loadScheduleForSelectedDate();
  }

  async function loadScheduleForSelectedDate(){
    const date = els.dateSelect.value;
    localStorage.setItem("bmc_display_date", date);

    els.status.textContent = `Loading schedule for ${date}…`;
    const data = await fetchJSON(`${API_BASE}?date=${encodeURIComponent(date)}`);

    schedule.date = data.date;
    schedule.slots = data.slots || [];
    schedule.defaultLastSlotMinutes = data.defaultLastSlotMinutes || 10;
    schedule.lastUpdated = new Date().toLocaleString();

    els.status.textContent = `Loaded ${schedule.slots.length} slot(s) for ${date}`;
    render();
  }

  // Clock + countdown tick
  setInterval(() => {
    els.nowClock.textContent = fmtClock(new Date());
    render();
  }, 1000);

  // Periodic data refresh (keeps clubs updated if sheet changes)
  setInterval(() => {
    if (!els.dateSelect.disabled) loadScheduleForSelectedDate().catch(() => {});
  }, 60000);

  els.dateSelect.addEventListener('change', () => {
    loadScheduleForSelectedDate().catch(err => {
      els.status.innerHTML = `<span class="err">${err.message}</span>`;
    });
  });

  els.refreshBtn.addEventListener('click', () => {
    loadScheduleForSelectedDate().catch(err => {
      els.status.innerHTML = `<span class="err">${err.message}</span>`;
    });
  });

  // Init
  (async function init(){
    try {
      if (!API_BASE || API_BASE.includes("YOUR_WEB_APP_URL_HERE")) {
        els.status.innerHTML = `<span class="err">Set API_BASE to your Apps Script Web App URL.</span>`;
        return;
      }
      await loadDates();
    } catch (err) {
      els.status.innerHTML = `<span class="err">${err.message}</span>`;
    }
  })();
</script>
</body>
</html>
