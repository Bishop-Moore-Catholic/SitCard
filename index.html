<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digital Sit Card</title>

  <style>
    :root {
      --border: #d0d7de;
      --bg: #f6f8fa;
      --textMuted: #57606a;
      --err: #b42318;
      --blue: #0969da;
      --radius: 12px;

      /* BMC crest gold palette */
      --bmcGold: #908060;
      --bmcGold2: #a79267;
      --bmcGoldLight: #cdbf9e;
      --bmcInk: #0b0f18;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
    }

    .wrap { max-width: 720px; margin: 0 auto; padding: 20px; }
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
    }

    h1 { font-size: 20px; margin: 0 0 10px; }
    .hint { color: var(--textMuted); font-size: 12px; margin-top: 6px; }

    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr 1fr;
      margin-top: 14px;
    }
    .grid > .full { grid-column: 1 / -1; }

    label { font-size: 12px; color: var(--textMuted); display: block; margin-bottom: 6px; }

    input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 16px;
      background: #fff;
    }
    input:focus {
      outline: 2px solid rgba(9,105,218,.25);
      border-color: var(--blue);
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }

    button {
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
    }
    button.primary { background: var(--blue); border-color: var(--blue); color: #fff; }
    button.danger { background: var(--err); border-color: var(--err); color: #fff; }

    .error { color: var(--err); font-size: 13px; margin-top: 10px; display:none; }

    /* ===== Modal (Trading Card) ===== */
    .modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.7);
      display: none;
      z-index: 9999;
      padding: 16px;
    }
    .modal[aria-hidden="false"] { display: grid; place-items: center; }

    .tcCard{
      width: min(520px, 100%);
      position: relative;
      border-radius: 22px;
      overflow: hidden;
      isolation: isolate;

      background:
        radial-gradient(140% 140% at 0% 0%,
          rgba(144,128,96,.22) 0%,
          rgba(11,15,24,1) 55%,
          rgba(7,10,18,1) 100%);
      border: 1px solid rgba(144,128,96,.35);
      box-shadow:
        0 20px 60px rgba(0,0,0,.55),
        inset 0 0 0 1px rgba(255,255,255,.05);

      --rx: 0deg;
      --ry: 0deg;
      --mx: 50%;
      --my: 50%;

      transform: rotateX(var(--rx)) rotateY(var(--ry));
      transform-style: preserve-3d;
    }

   /* Foil shimmer (loop-safe + larger scale, bright/pearly + gold) */
  .tcFoil{
    position: absolute;
    inset: 0;
    pointer-events: none;

    /* Keep the corner fix */
    border-radius: 22px;
    clip-path: inset(0 round 22px);

    /* Keep blend inside card */
    mix-blend-mode: screen;
    opacity: .45;
    isolation: isolate;
  }

  /* Put the moving shimmer on a pseudo element so clipping is perfect */
  .tcFoil::before{
    content:"";
    position:absolute;
    inset: -120%;              /* <-- BIGGER “scale” so drift is visible */
    border-radius: 999px;

    background:
      conic-gradient(
        from 180deg at var(--mx) var(--my),
        rgba(255, 233, 190, .95),
        rgba(255, 214, 140, .90),
        rgba(255, 245, 225, .90),
        rgba(210, 245, 255, .75),
        rgba(240, 220, 255, .75),
        rgba(220, 255, 235, .75),
        rgba(255, 223, 165, .92),
        rgba(255, 233, 190, .95)
      );

    filter: blur(16px) saturate(1.28) brightness(1.08);

    /* ✅ Closed loop: 0% and 100% match exactly */
    animation: foilLoop 4.2s linear infinite;
  }

  /* Loop-safe drift + rotation */
  @keyframes foilLoop{
    0%   { transform: translate3d(-10%, -7%, 0) rotate(0deg); }
    50%  { transform: translate3d( 10%,  7%, 0) rotate(180deg); }
    100% { transform: translate3d(-10%, -7%, 0) rotate(360deg); }
}


    .tcEdge{
      position: absolute;
      inset: 0;
      border-radius: 22px;
      pointer-events: none;
      clip-path: inset(0 round 22px);

      background:
        linear-gradient(135deg,
          rgba(205,191,158,.55),
          rgba(255,255,255,.08),
          rgba(144,128,96,.35));
      mix-blend-mode: screen;
    }

    .tcInner{
      position: relative;
      padding: 18px 16px 20px;
      text-align: center;
    }

    .tcTitle{
      font-weight: 900;
      letter-spacing: .4px;
      color: #fff3d8;
    }

    .tcSub{
      font-size: 12px;
      color: rgba(220,235,255,.8);
      margin-top: 2px;
    }

    .tcQRWrap{
      position: relative;
      margin: 16px auto;
      padding: 14px;
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      border: 1px solid rgba(255,215,140,.2);

      /* ✅ hard center on all devices */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tcQRWrap img#modalQRImg{
      display: block;

      /* ✅ deterministic box */
      width: min(320px, 80vw);
      height: auto;

      background: #fff;
      border-radius: 12px;
    }

    .qrLogo{
      position: absolute;

      /* ✅ true center anchor */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);

      width: 64px;
      height: 64px;
      padding: 8px;
      background: rgba(255,255,255,.92);
      border-radius: 16px;
      border: 1px solid rgba(144,128,96,.25);
      box-shadow: 0 10px 30px rgba(0,0,0,.4);

      pointer-events: none;
    }

    @media (max-width: 420px) {
      .qrLogo {
        display: none;
      }
    }
    
    .tcQRWrap{ position: relative; }

    .tcName{
      font-size: 22px;
      font-weight: 900;
      color: #fff;
      margin-top: 6px;
    }

    .tcMeta{
      font-size: 12px;
      color: rgba(220,235,255,.8);
    }

    .warnText{
      text-align: center;
      font-size: 12px;
      color: rgba(220,235,255,.75);
      margin-top: 8px;
      min-height: 18px;
    }

    .tcActions{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 16px;
    }

    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Generate Your Digital Sit Card</h1>
      <div class="hint">Fill this out while you’re in line. Keep the QR on your screen. <strong>Please no nicknames!</strong></div>

      <div class="grid">
        <div>
          <label for="first">First name</label>
          <input id="first" />
        </div>
        <div>
          <label for="last">Last name</label>
          <input id="last" />
        </div>
        <div class="full">
          <label for="sid">Student ID</label>
          <input id="sid" inputmode="numeric" maxlength="7" placeholder="2026###" />
          <div class="hint">2026–2029 + 3 digits</div>
          <div id="err" class="error"></div>
        </div>
      </div>

      <div class="row">
        <button id="generate" class="primary">Generate Sit Card</button>
        <button id="clear">Clear</button>
      </div>
    </div>
  </div>

  <div id="qrModal" class="modal" aria-hidden="true">
    <div class="tcCard">
      <div class="tcFoil"></div>
      <div class="tcEdge"></div>

      <div class="tcInner">
        <div class="tcTitle">BMC Digital Sit Card</div>
        <div class="tcSub">Present to attendant after your picture is taken.</div>

        <div class="tcQRWrap">
          <img id="modalQRImg" alt="QR Code" />
          <img class="qrLogo" src="logo.png" alt="" onerror="this.style.display='none'" />
        </div>

        <div class="tcName" id="cardName"></div>
        <div class="tcMeta">Student ID: <span id="cardSid"></span></div>

        <div id="warnText" class="warnText"></div>

        <div class="tcActions">
          <button id="modalClose">Close</button>
          <button id="modalClear" class="danger">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    const STUDENT_ID_RE = /^20(2[6-9])\d{3}$/;

    const firstEl = document.getElementById("first");
    const lastEl = document.getElementById("last");
    const sidEl = document.getElementById("sid");
    const errEl = document.getElementById("err");

    const modal = document.getElementById("qrModal");
    const modalQRImg = document.getElementById("modalQRImg");
    const warnText = document.getElementById("warnText");

    let closeArmed = false;
    let clearArmed = false;
    let armTimer = null;

    function arm(kind){
      closeArmed = (kind === "close");
      clearArmed = (kind === "clear");
      warnText.textContent = kind === "close"
        ? "Tap Close again to confirm."
        : "Tap Clear again to confirm.";
      if (armTimer) clearTimeout(armTimer);
      armTimer = setTimeout(()=>{
        closeArmed = false;
        clearArmed = false;
        warnText.textContent = "";
        armTimer = null;
      }, 2500);
    }

    function setError(msg){
      errEl.style.display = msg ? "block":"none";
      errEl.textContent = msg || "";
    }

    function validateSid(){
      sidEl.value = sidEl.value.replace(/[^\d]/g,"").slice(0,7);
      const ok = STUDENT_ID_RE.test(sidEl.value);
      if (!ok && sidEl.value) setError("Invalid Student ID");
      else setError("");
      return ok;
    }

    function buildPayload(){
      if (!firstEl.value || !lastEl.value) {
        setError("Enter first and last name");
        return "";
      }
      if (!validateSid()) return "";

      return JSON.stringify({
        f: firstEl.value.trim(),
        l: lastEl.value.trim(),
        sid: sidEl.value
      });
    }

    function renderQR(payload){
      const tmp = document.createElement("div");
      tmp.style.position = "fixed";
      tmp.style.left = "-99999px";
      tmp.style.top = "0";
      document.body.appendChild(tmp);

      // Render using existing settings
      new QRCode(tmp, { text: payload, width: 420, height: 420 });

      const canvas = tmp.querySelector("canvas");

      // --- Normalize QR centering (fix asymmetric quiet-zone) ---
      try {
        const srcW = canvas.width;
        const srcH = canvas.height;
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        const img = ctx.getImageData(0, 0, srcW, srcH).data;

        // Find bounds of "dark" pixels (ignore the white margin)
        let minX = srcW, minY = srcH, maxX = -1, maxY = -1;

        // Threshold: treat anything not near-white as "dark module"
        const isDark = (r, g, b, a) => a > 0 && (r + g + b) < 740; // ~ not-white

        for (let y = 0; y < srcH; y++) {
          for (let x = 0; x < srcW; x++) {
            const i = (y * srcW + x) * 4;
            if (isDark(img[i], img[i+1], img[i+2], img[i+3])) {
              if (x < minX) minX = x;
              if (y < minY) minY = y;
              if (x > maxX) maxX = x;
              if (y > maxY) maxY = y;
            }
          }
        }

        // If bounds are valid, re-center with equal margins
        if (maxX > minX && maxY > minY) {
          const contentW = (maxX - minX + 1);
          const contentH = (maxY - minY + 1);
          const contentSize = Math.max(contentW, contentH);

          // Keep a comfortable quiet zone (padding) around the modules
          const pad = Math.round(srcW * 0.08); // ~8% padding
          const outSize = contentSize + pad * 2;

          const out = document.createElement("canvas");
          out.width = outSize;
          out.height = outSize;
          const octx = out.getContext("2d");

          // White background
          octx.fillStyle = "#fff";
          octx.fillRect(0, 0, outSize, outSize);

          // Draw cropped content centered
          const dx = Math.round((outSize - contentW) / 2);
          const dy = Math.round((outSize - contentH) / 2);

          octx.drawImage(
            canvas,
            minX, minY, contentW, contentH,
            dx, dy, contentW, contentH
          );

          modalQRImg.src = out.toDataURL("image/png");
        } else {
          // Fallback to original
          modalQRImg.src = canvas.toDataURL("image/png");
        }
      } catch (e) {
        // Fallback to original if anything goes wrong
        modalQRImg.src = canvas.toDataURL("image/png");
      }

      // Populate trading card labels (your step 4)
      try {
        const obj = JSON.parse(payload);
        document.getElementById("cardName").textContent = (obj.f||"")+" "+(obj.l||"");
        document.getElementById("cardSid").textContent = obj.sid||"";
      } catch(e){}

      tmp.remove();
    }


    function openModal(){
      closeArmed = false;
      clearArmed = false;
      if (armTimer) { clearTimeout(armTimer); armTimer = null; }
      warnText.textContent = "";
      modal.setAttribute("aria-hidden","false");
    }
    function closeModal(){ modal.setAttribute("aria-hidden","true"); }

    document.getElementById("generate").onclick = ()=>{
      const payload = buildPayload();
      if (!payload) return;
      renderQR(payload);
      openModal();
    };

    document.getElementById("clear").onclick = ()=>{
      firstEl.value = lastEl.value = sidEl.value = "";
      modalQRImg.src = "";
      setError("");
    };

    document.getElementById("modalClose").onclick = ()=>{
      if (!closeArmed) { arm("close"); return; }
      closeArmed = false;
      warnText.textContent = "";
      closeModal();
    };

    document.getElementById("modalClear").onclick = ()=>{
      if (!clearArmed) { arm("clear"); return; }
      clearArmed = false;
      warnText.textContent = "";
      document.getElementById("clear").click();
      closeModal();
    };

    sidEl.addEventListener("input", validateSid);

    const card = document.querySelector(".tcCard");
    card?.addEventListener("pointermove",(e)=>{
      const r = card.getBoundingClientRect();
      const px = (e.clientX - r.left) / r.width;
      const py = (e.clientY - r.top) / r.height;
      card.style.setProperty("--ry", ((px - .5) * 10) + "deg");
      card.style.setProperty("--rx", ((.5 - py) * 10) + "deg");
      card.style.setProperty("--mx", (px * 100) + "%");
      card.style.setProperty("--my", (py * 100) + "%");
    });
    card?.addEventListener("pointerleave",()=>{
      card.style.setProperty("--rx","0deg");
      card.style.setProperty("--ry","0deg");
      card.style.setProperty("--mx","50%");
      card.style.setProperty("--my","50%");
    });
  </script>
</body>
</html>
