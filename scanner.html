<!doctype html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  body {
    margin: 0;
    padding: 16px;
    background: #f6f8fb;
    transition: background-color 180ms ease
  }

  /* OK background flash */
  body.bg-ok { background-color: #00e36a; }
  .wrap { max-width: 980px; margin: 0 auto; display: grid; gap: 14px; }
  .card { background: #ffffff; border: 1px solid #d7e0ee; border-radius: 14px; padding: 14px; }
  label { font-size: 12px; opacity: .8; display:block; margin-bottom: 6px; }
  input {
    width: 100%; box-sizing: border-box; padding: 10px 12px;
    border-radius: 12px; border: 1px solid #c6d2e6; background: #ffffff; color: #0f172a;
    outline: none;
  }
  input:disabled { opacity: .65; cursor: not-allowed; }
  .toolbar { display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap: wrap; }
  .btn {
    border: 1px solid #c6d2e6; background: #ffffff; color: #0f172a;
    border-radius: 12px; padding: 10px 12px; cursor: pointer;
  }
  .btn:active { transform: translateY(1px); }
  .btn[disabled] { opacity: .55; cursor: not-allowed; }
  .btnPrimary { background: #eaf2ff; border-color: #8fb3ff; }
  .btnDanger  { background: #feecec; border-color: #f2a3a3; }
  .btnBigPlus { font-size: 22px; padding: 10px 18px; border-radius: 14px; }
  .btnSmallMinus { font-size: 14px; padding: 6px 10px; border-radius: 12px; opacity: .95; }
  .pill { display:inline-flex; gap:10px; align-items:center; padding: 8px 10px; border: 1px solid #c6d2e6; border-radius: 999px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  .status { display:flex; gap:10px; flex-wrap:wrap; }
  .hint { font-size: 12px; opacity: .75; line-height: 1.35; }

  .good { color: #0f8a4c; }
  .warn { color: #b45309; }
  .bad  { color: #b91c1c; }

  .clubRow { display:flex; gap:12px; align-items:flex-end; flex-wrap: wrap; }
  .clubRow > .grow { flex: 1 1 320px; }
  .rowpos { display:flex; gap:10px; align-items:center; padding-bottom: 2px; flex-wrap: wrap; }
  .label { font-size: 12px; opacity: .8; margin-bottom: 6px; }
  .tiny { font-size: 12px; opacity: .75; }

  .videoWrap {
    position: relative;
    border-radius: 14px;
    overflow: hidden;
    background: #000;
  }

  .videoWrap video {
    width: 100%;
    height: auto;
    transform-origin: center center;
    object-fit: cover;
    will-change: transform;
  }

  video { width: 100%; display:block; border-radius: 14px; border: 1px solid #d7e0ee; background:#000; }
  #flashOverlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    opacity: 0;
    transition: opacity 120ms ease;
    mix-blend-mode: screen;
  }
  #flashOverlay.ok  { background: rgba(34, 197, 94, 0.80); }
  #flashOverlay.dup { background: rgba(245, 158, 11, 0.40); }
  #flashOverlay.err { background: rgba(239, 68, 68, 0.40); }
  .scan-region-highlight-svg {display: none!important;}

  .history { margin-top: 10px; border-top: 1px solid #d7e0ee; padding-top: 10px; }
  .historyItem { display:flex; justify-content:space-between; gap:10px; padding:8px 10px; border: 1px solid #d7e0ee; border-radius: 12px; margin-top: 8px; }
  .historyLeft { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

  select.camSelect{
    border: 1px solid #c6d2e6;
    background: #ffffff;
    color: #0f172a;
    border-radius: 12px;
    padding: 10px 12px;
    cursor: pointer;
    max-width: 280px;
  }
  select.camSelect:disabled{ opacity:.55; cursor:not-allowed; }

  /* Queue warning line */
  .queueLine { margin-top: 6px; display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
  .qPill { border-color:#c6d2e6; }
  .qGood { color:#0f8a4c; border-color:#9ae6b4; background:#f0fff4; }
  .qWarn { color:#b45309; border-color:#fcd34d; background:#fffbeb; }
  .qSev  { color:#7c2d12; border-color:#fdba74; background:#fff7ed; }
  .qBad  { color:#b91c1c; border-color:#fca5a5; background:#fef2f2; }
</style>

  <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
</head>

<body>
<div class="wrap">

  <div class="card">
    <div class="toolbar">
      <div>
        <div style="font-size:18px; font-weight:700;">QR Scanner Portal</div>
        <div class="hint">
          Operator: <span class="mono" id="operatorTop">Loading…</span> ·
          Session: <span class="mono" id="sessionTop">—</span>
        </div>
        <div class="tiny">Save Club locks the club name and starts camera automatically.</div>
      </div>
      <div class="status" id="scanStatus"></div>
    </div>
  </div>

  <div class="card">
    <div class="clubRow">
      <div class="grow">
        <label>Club</label>
        <input id="club" placeholder="e.g., Girls Soccer JV">
      </div>

      <div>
        <div class="label">Row / Pos</div>
        <div class="rowpos">
          <span class="pill"><span>Row</span><span class="mono" id="rowNum">1</span></span>
          <span class="pill"><span>Pos</span><span class="mono" id="rowPos">0</span></span>
          <button class="btn btnBigPlus" id="btnPlus" title="Next Row">+</button>
          <button class="btn btnSmallMinus" id="btnMinus" title="Previous Row">−</button>
        </div>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn btnPrimary" id="btnSaveClub">Save Club (Lock + Start Camera)</button>
      <button class="btn btnDanger" id="btnNewClub">New Club / New Session</button>
    </div>
    <div class="tiny" style="margin-top:8px;">
      New Club stops the camera cleanly, resets counters, clears local history, and unlocks club editing.
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <div>
        <div style="font-weight:700;">Camera Scan</div>
        <div class="hint">Green flash = OK. Yellow flash = duplicate suppressed.</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <select id="camSelect" class="camSelect" title="Camera source"></select>
        <button class="btn" id="btnRefreshCams" title="Refresh camera list">Refresh</button>
        <button class="btn btnPrimary" id="btnStartCam">Start Camera</button>
        <button class="btn" id="btnStopCam">Stop</button>
      </div>
    </div>

    <div class="videoWrap">
      <video id="video" playsinline></video>
      <div id="flashOverlay" class="ok"></div>
    </div>

    <div class="history">
      <div style="font-weight:700;">Recent scans (local)</div>
      <div class="tiny">Last 10 successful scans recorded on this device (clears when you start a new club/session).</div>

      <div class="queueLine tiny" id="queueInfo">
        <span class="pill mono qPill" id="queuePill">Queue: <span id="queueCount">0</span></span>
        <span class="tiny" id="queueHint"></span>
      </div>

      <div id="historyList"></div>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:700;">Manual Entry (Student ID only)</div>
    <div class="hint">Enter <span class="mono">20xxxxx</span>. Enter submits.</div>

    <div style="margin-top:10px;">
      <label>StudentID</label>
      <input id="manualId" class="mono" placeholder="20xxxxx" inputmode="numeric">
    </div>

    <div style="margin-top:10px;">
      <label>Notes (optional)</label>
      <input id="notes" placeholder="e.g., retake, name corrected, etc.">
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn btnPrimary" id="btnSubmitManual">Log</button>
      <button class="btn" id="btnClearManual">Clear</button>
    </div>
  </div>

</div>

<script>
  const els = {
    operatorTop: document.getElementById("operatorTop"),
    sessionTop: document.getElementById("sessionTop"),
    scanStatus: document.getElementById("scanStatus"),
    club: document.getElementById("club"),
    rowNum: document.getElementById("rowNum"),
    rowPos: document.getElementById("rowPos"),
    btnPlus: document.getElementById("btnPlus"),
    btnMinus: document.getElementById("btnMinus"),
    btnNewClub: document.getElementById("btnNewClub"),
    btnSaveClub: document.getElementById("btnSaveClub"),
    btnStartCam: document.getElementById("btnStartCam"),
    btnStopCam: document.getElementById("btnStopCam"),
    camSelect: document.getElementById("camSelect"),
    btnRefreshCams: document.getElementById("btnRefreshCams"),
    video: document.getElementById("video"),
    flashOverlay: document.getElementById("flashOverlay"),
    historyList: document.getElementById("historyList"),
    manualId: document.getElementById("manualId"),
    notes: document.getElementById("notes"),
    btnSubmitManual: document.getElementById("btnSubmitManual"),
    btnClearManual: document.getElementById("btnClearManual"),
    queuePill: document.getElementById("queuePill"),
    queueCount: document.getElementById("queueCount"),
    queueHint: document.getElementById("queueHint"),
  };

  // ---- flash feedback (priority + lock) ----
  let flashTimer = null;
  let flashLockedUntil = 0;
  let flashLockedKind = ""; // "ok" when OK is active

  function flash(kind) {
    if (!els.flashOverlay) return;
    const now = Date.now();

    // If OK flash is active, ignore DUP/ERR until it clears
    if (flashLockedKind === "ok" && now < flashLockedUntil && kind !== "ok") return;

    els.flashOverlay.style.opacity = "0";
    els.flashOverlay.className = "";
    void els.flashOverlay.offsetHeight;

    els.flashOverlay.classList.add(kind || "ok");
    els.flashOverlay.style.opacity = "1";

    const duration =
      kind === "ok"  ? 1500 :
      kind === "dup" ? 250  :
      kind === "err" ? 1000 :
      200;

    if (kind === "ok") document.body.classList.add("bg-ok");

    if (kind === "ok") {
      flashLockedKind = "ok";
      flashLockedUntil = now + duration;
    } else {
      flashLockedKind = "";
      flashLockedUntil = 0;
    }

    clearTimeout(flashTimer);
    flashTimer = setTimeout(() => {
      els.flashOverlay.style.opacity = "0";
      if (kind === "ok") {
        document.body.classList.remove("bg-ok");
        flashLockedKind = "";
        flashLockedUntil = 0;
      }
    }, duration);
  }

  // ---- local session + counters ----
  const state = {
    sessionId: newSessionId(),
    club: "",
    clubLocked: false,
    row: 1,
    pos: 0
  };

  function newSessionId() {
    const rand = Math.random().toString(36).slice(2, 8).toUpperCase();
    return "SESSION-" + Date.now().toString(36).toUpperCase() + "-" + rand;
  }

  function renderState() {
    els.sessionTop.textContent = state.sessionId;
    els.rowNum.textContent = String(state.row);
    els.rowPos.textContent = String(state.pos);
    els.club.disabled = state.clubLocked;
    els.btnSaveClub.disabled = state.clubLocked;
    els.btnStartCam.disabled = !state.clubLocked ? false : els.btnStartCam.disabled;
  }

  // ---- UI helpers ----
  function pill(text, cls="") {
    const d = document.createElement("div");
    d.className = `pill mono ${cls}`.trim();
    d.textContent = text;
    return d;
  }

  function showStatus(res) {
    els.scanStatus.innerHTML = "";
    if (!res) return;

    const s = String(res.status || "").toUpperCase();
    const cls =
      (s === "OK") ? "good" :
      (s.startsWith("DUPLICATE") || s === "QUEUED") ? "warn" :
      "bad";

    els.scanStatus.appendChild(pill(`Status: ${res.status}`, cls));
    if (res.message) els.scanStatus.appendChild(pill(res.message, cls));
    if (res.student?.studentId) els.scanStatus.appendChild(pill(res.student.studentId));
  }

  function showScanningClub() {
    const club = (state.club || "").trim();
    if (!club) return showStatus({ status: "OK", message: "No club selected. Enter a club and press Save Club." });
    showStatus({ status: "OK", message: `Scanning club: ${club}` });
  }

  // ---- history (local) ----
  const history = [];
  const HISTORY_MAX = 10;

  function clearHistory() { history.length = 0; renderHistory(); }

  function pushHistory(item) {
    history.unshift(item);
    while (history.length > HISTORY_MAX) history.pop();
    renderHistory();
  }

  function renderHistory() {
    els.historyList.innerHTML = "";
    if (history.length === 0) {
      const empty = document.createElement("div");
      empty.className = "tiny";
      empty.style.marginTop = "8px";
      empty.textContent = "No successful scans recorded yet for this club/session.";
      els.historyList.appendChild(empty);
      return;
    }

    history.forEach(h => {
      const div = document.createElement("div");
      div.className = "historyItem";

      const left = document.createElement("div");
      left.className = "historyLeft";

      left.appendChild(pill("OK", "good"));
      left.appendChild(pill(h.id || "—"));
      left.appendChild(pill(`R${h.row} P${h.pos}`));

      const right = document.createElement("div");
      right.className = "tiny mono";
      right.textContent = new Date(h.t).toLocaleTimeString();

      div.appendChild(left);
      div.appendChild(right);
      els.historyList.appendChild(div);
    });
  }

  // ---- local duplicate suppression (raw QR text) ----
  let lastRaw = "";
  let lastAt = 0;
  const COOLDOWN_MS = 1200;
  const HARD_SUPPRESS_SAME_AS_PREV = true;

  function resetLocalDuplicateMemory() { lastRaw = ""; lastAt = 0; }

  function shouldSendRaw(raw) {
    const now = Date.now();
    if (!raw) return false;
    if (HARD_SUPPRESS_SAME_AS_PREV && raw === lastRaw) return false;
    if (raw === lastRaw && (now - lastAt) < COOLDOWN_MS) return false;
    lastRaw = raw;
    lastAt = now;
    return true;
  }

  function extractStudentId(raw) {
    const s = String(raw || "").trim();
    if (/^20\d{5}$/.test(s)) return s;
    try {
      const o = JSON.parse(s);
      return String(o.id || o.studentId || o.sid || o.SID || "").trim();
    } catch { return ""; }
  }

  // ---- infer gradYear/grade from StudentID prefix (first 4 digits) ----
  function inferGradYearFromSid(sid) {
    const m = String(sid || "").match(/^(\d{4})/);
    return m ? Number(m[1]) : null;
  }

  function inferGradeFromGradYear(gradYear, asOf = new Date()) {
    if (!Number.isFinite(gradYear)) return null;
    const y = asOf.getFullYear();
    const m = asOf.getMonth();
    const schoolYearEnds = (m >= 6) ? (y + 1) : y;
    const grade = 12 - (gradYear - schoolYearEnds);
    return (grade >= 9 && grade <= 12) ? grade : null;
  }

  // ---- GAS wrapper ----
  function gas(fn, args, ok, fail) {
    if (!window.google || !google.script || !google.script.run) {
      showStatus({status:"ERROR", message:"google.script.run unavailable. Open the deployed /exec URL in a normal tab."});
      return;
    }
    google.script.run
      .withSuccessHandler(ok)
      .withFailureHandler(fail || (err => showStatus({status:"ERROR", message:String(err)})))
      [fn].apply(null, args);
  }

  // ---- async send queue (BATCHED, localStorage-backed) ----
  const SENDQ_KEY = "yearbook.scanSendQueue.v3";
  const BATCH_SIZE = 15;
  const FLUSH_EVERY_MS = 900;

  let sendQueue = [];
  let isFlushing = false;

  function updateQueueUI() {
    const n = sendQueue.length;
    if (els.queueCount) els.queueCount.textContent = String(n);
    if (!els.queuePill) return;

    els.queuePill.className = "pill mono qPill";
    const offline = (typeof navigator !== "undefined" && navigator.onLine === false);

    let hint = "";
    if (offline) {
      hint = "Offline — will upload when back online.";
      els.queuePill.classList.add("qBad");
    } else if (n === 0) {
      hint = "All caught up.";
      els.queuePill.classList.add("qGood");
    } else if (n < 25) {
      hint = "Uploading normally.";
      els.queuePill.classList.add("qWarn");
    } else if (n < 50) {
      hint = "Queue backing up — check Wi-Fi.";
      els.queuePill.classList.add("qSev");
    } else {
      hint = "Queue very large — pause scanning or fix network.";
      els.queuePill.classList.add("qBad");
    }

    if (els.queueHint) els.queueHint.textContent = hint;
  }

  function serializeQueueItem(it) {
    return {
      t: it.t || Date.now(),
      payload: String(it.payload || "").trim(),
      studentIdGuess: String(it.studentIdGuess || "").trim(),
      club: String(it.club || "").trim(),
      notes: String(it.notes || "").trim(),
      row: Number(it.row || 1),
      pos: Number(it.pos || 0),
      sessionId: String(it.sessionId || "").trim(),
      gradYear: it.gradYear ?? null,
      grade: it.grade ?? null
    };
  }

  function loadSendQueue() {
    try {
      const raw = localStorage.getItem(SENDQ_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      sendQueue = Array.isArray(arr) ? arr.map(serializeQueueItem) : [];
    } catch { sendQueue = []; }
    updateQueueUI();
  }

  function saveSendQueue() {
    try { localStorage.setItem(SENDQ_KEY, JSON.stringify(sendQueue.map(serializeQueueItem))); } catch {}
    updateQueueUI();
  }

  function enqueueSend(item) {
    sendQueue.push(serializeQueueItem(item));
    saveSendQueue();
    flushSendQueue();
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function flushSendQueue() {
    if (isFlushing) return;
    if (!sendQueue.length) { updateQueueUI(); return; }
    if (typeof navigator !== "undefined" && navigator.onLine === false) { updateQueueUI(); return; }

    isFlushing = true;
    try {
      while (sendQueue.length) {
        const batch = sendQueue.slice(0, BATCH_SIZE);

        const payload = batch.map(it => ({
          payloadRaw: it.payload,
          club: it.club,
          notes: it.notes,
          rowNumber: it.row,
          rowPosition: it.pos,
          sessionId: it.sessionId,
          gradYearParam: it.gradYear,
          gradeParam: it.grade,
          clientId: ""
        }));

        const res = await new Promise((resolve, reject) => {
          gas("recordScansBatch", [payload], resolve, reject);
        });

        if (res?.operator) els.operatorTop.textContent = res.operator;

        const results = Array.isArray(res?.results) ? res.results : [];

        for (let i = 0; i < batch.length; i++) {
          const it = batch[i];
          const r = results[i] || { status: "ERROR" };
          const status = String(r.status || "ERROR").toUpperCase();

          if (status === "OK") {
            pushHistory({
              t: it.t,
              id: (r.student?.studentId || it.studentIdGuess || "—"),
              status: "OK",
              row: it.row,
              pos: it.pos
            });
          } else if (status === "INVALID_JSON") {
            showStatus({ status: "INVALID_JSON", message: "Invalid QR payload (ignored)." });
            flash("err");
          } else if (status === "INVALID_ID") {
            showStatus({ status: "INVALID_ID", message: "StudentID failed validation." });
            flash("err");
          } else {
            showStatus({ status: "ERROR", message: "Server response: " + status });
            flash("err");
          }
        }

        sendQueue.splice(0, batch.length);
        saveSendQueue();

        await sleep(120);
      }
    } catch (err) {
      console.warn("Batch flush failed; will retry.", err);
      await sleep(1200);
    } finally {
      isFlushing = false;
      updateQueueUI();
    }
  }

  setInterval(flushSendQueue, FLUSH_EVERY_MS);
  window.addEventListener("online", () => { updateQueueUI(); flushSendQueue(); });
  window.addEventListener("offline", () => { updateQueueUI(); });

  // ---- per-session dedupe by studentId (prevents dup increment + dup sends) ----
  const seenThisSession = new Set();
  function resetSeenThisSession() { seenThisSession.clear(); }
  function makeSeenKey(studentId) {
    return `${state.club}|${state.sessionId}|${String(studentId || "").trim()}`;
  }

  // ---- scanner control ----
  let scanner = null;
  let camRunning = false;
  let selectedCameraId = "";

  async function refreshCameras(autoSelect = true) {
    if (typeof QrScanner === "undefined") return;
    try {
      const cams = await QrScanner.listCameras(true);
      const prev = els.camSelect.value || selectedCameraId || "";
      els.camSelect.innerHTML = "";

      if (!cams || cams.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No cameras found";
        els.camSelect.appendChild(opt);
        els.camSelect.disabled = true;
        selectedCameraId = "";
        return;
      }

      cams.forEach((c, idx) => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.label || `Camera ${idx + 1}`;
        els.camSelect.appendChild(opt);
      });

      els.camSelect.disabled = false;

      const stillThere = cams.some(c => c.id === prev);
      const pick = stillThere ? prev : (autoSelect ? cams[0].id : "");
      els.camSelect.value = pick;
      selectedCameraId = pick;
    } catch (e) {
      els.camSelect.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Camera list unavailable";
      els.camSelect.appendChild(opt);
      els.camSelect.disabled = true;
      selectedCameraId = "";
    }
  }

  async function startCamera() {
    if (typeof QrScanner === "undefined") {
      showStatus({status:"ERROR", message:"qr-scanner failed to load."});
      return;
    }
    QrScanner.WORKER_PATH = "https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js";

    try {
      await stopCamera(true);
      await refreshCameras(false);
      selectedCameraId = els.camSelect && !els.camSelect.disabled ? (els.camSelect.value || selectedCameraId) : selectedCameraId;

      scanner = new QrScanner(
        els.video,
        (result) => {
          const raw = String(result?.data || result || "").trim();
          if (!raw) return;

          if (!shouldSendRaw(raw)) {
            flash("dup");
            showStatus({ status: "DUPLICATE_LOCAL", message: "Duplicate (local suppression) — not sent." });
            return;
          }
          logScan(raw, "camera");
        },
        {
          preferredCamera: (selectedCameraId || "environment"),
          maxScansPerSecond: 15,
          calculateScanRegion: (video) => {
            const w = video.videoWidth || video.clientWidth;
            const h = video.videoHeight || video.clientHeight;
            return { x: 0, y: 0, width: w, height: h };
          },
          highlightScanRegion: true,
          highlightCodeOutline: true
        }
      );

      els.btnStartCam.disabled = true;
      const old = els.btnStartCam.textContent;
      els.btnStartCam.textContent = "Starting…";
      await scanner.start();
      freezeVideoOrientation();
      camRunning = true;
      els.btnStartCam.disabled = false;
      els.btnStartCam.textContent = old;

      showStatus({status:"OK", message: state.club ? `Camera started. Scanning club: ${state.club}` : "Camera started."});
    } catch (e) {
      camRunning = false;
      els.btnStartCam.disabled = false;
      els.btnStartCam.textContent = "Start Camera";
      showStatus({status:"ERROR", message:"Camera failed: " + (e?.message || String(e))});
    }
  }

  async function stopCamera(destroy = false) {
    try {
      if (scanner) {
        scanner.stop();
        camRunning = false;
        if (destroy) {
          scanner.destroy();
          scanner = null;
        }
      }
    } catch (e) {}
  }

  // ---- record scan (ASYNC, BATCHED upload) ----
  function logScan(payload, source) {
    if (!state.clubLocked || !state.club) {
      showStatus({ status: "ERROR", message: "Save Club first (locks club + starts camera)." });
      return;
    }

    const t = Date.now();
    const raw = String(payload || "").trim();
    const studentIdGuess = extractStudentId(raw);
    const gradYear = inferGradYearFromSid(studentIdGuess);
    const grade = inferGradeFromGradYear(gradYear);

    if (!studentIdGuess) {
      flash("err");
      showStatus({ status: "INVALID_JSON", message: "Invalid QR (no StudentID detected) — not queued." });
      return;
    }

    const key = makeSeenKey(studentIdGuess);
    if (seenThisSession.has(key)) {
      flash("dup");
      showStatus({ status: "DUPLICATE_LOCAL", message: "Duplicate (same student already scanned this session) — not queued." });
      return;
    }

    const committedPos = state.pos + 1;
    state.pos = committedPos;
    seenThisSession.add(key);
    renderState();

    flash("ok");
    showStatus({ status: "QUEUED", message: "Queued… sending in background." });

    enqueueSend({
      t,
      payload: raw,
      studentIdGuess,
      club: state.club,
      notes: els.notes.value.trim(),
      row: state.row,
      pos: committedPos,
      sessionId: state.sessionId,
      gradYear,
      grade
    });
  }

  // ---- controls ----
  els.btnSaveClub.onclick = async () => {
    const clubText = els.club.value.trim();
    if (!clubText) return showStatus({ status: "ERROR", message: "Enter a club name first." });

    state.club = clubText;
    state.clubLocked = true;
    resetSeenThisSession();
    renderState();
    showScanningClub();
    await startCamera();
  };

  els.btnNewClub.onclick = async () => {
    const currentClub = (state.club || "").trim();
    const ok = confirm(
      currentClub
        ? `Start a NEW club/session?\n\nThis will clear “${currentClub}”, reset Row/Pos, clear local history, and restart the camera.`
        : "Start a NEW club/session?\n\nThis will clear the club field, reset Row/Pos, clear local history, and restart the camera."
    );
    if (!ok) return;

    const wasRunning = camRunning;
    await stopCamera(true);

    state.sessionId = newSessionId();
    state.club = "";
    state.clubLocked = false;
    els.club.value = "";
    state.row = 1;
    state.pos = 0;
    renderState();

    clearHistory();
    resetLocalDuplicateMemory();
    resetSeenThisSession();

    showStatus({status:"OK", message:"New club/session started. Enter club name and press Save Club."});

    if (wasRunning) {
      await startCamera();
      showStatus({status:"OK", message:"Camera restarted. Enter club name and press Save Club."});
    }
  };

  els.btnPlus.onclick = () => { state.row = Math.max(1, state.row + 1); state.pos = 0; renderState(); };
  els.btnMinus.onclick = () => { state.row = Math.max(1, state.row - 1); state.pos = 0; renderState(); };

  // manual
  function submitManual() {
    const id = els.manualId.value.trim();
    if (!/^20\d{5}$/.test(id)) return showStatus({status:"ERROR", message:"Enter a valid StudentID like 20xxxxx."});
    logScan(id, "manual");
    els.manualId.focus();
    els.manualId.select();
  }

  els.btnSubmitManual.onclick = submitManual;
  els.btnClearManual.onclick = () => { els.manualId.value = ""; els.notes.value = ""; els.manualId.focus(); };
  els.manualId.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); submitManual(); }
  });

  els.btnStartCam.onclick = startCamera;
  els.btnStopCam.onclick = async () => {
    await stopCamera(true);
    showStatus({status:"OK", message: state.club ? `Camera stopped. Scanning club: ${state.club}` : "Camera stopped."});
  };

  function freezeVideoOrientation() { els.video.style.transform = "rotate(0deg)"; }
  window.addEventListener("orientationchange", () => { freezeVideoOrientation(); });

  // camera source controls
  els.btnRefreshCams.onclick = async () => { await refreshCameras(true); showStatus({status:"OK", message:"Camera list refreshed."}); };

  els.camSelect.onchange = async () => {
    selectedCameraId = els.camSelect.value || "";
    if (camRunning) {
      await startCamera();
      showStatus({status:"OK", message: state.club ? `Camera switched. Scanning club: ${state.club}` : "Camera switched."});
    } else {
      showStatus({status:"OK", message:"Camera selected. Press Start Camera."});
    }
  };

  // init (refresh resumes uploads automatically)
  renderState();
  clearHistory();
  loadSendQueue();
  updateQueueUI();
  flushSendQueue();

  refreshCameras(true);
  showStatus({status:"OK", message:"Enter a club name, then press Save Club (locks + starts camera)."});
  gas("setupYearbookScannerSheets", [], () => { gas("getClientConfig", [], () => {}); });
</script>
</body>
</html>